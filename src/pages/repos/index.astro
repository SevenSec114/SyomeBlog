---
import "../../styles/list-page.css";
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import SearchBar from "../../components/SearchBar.astro";
---

<Layout title="Public Repos">
  <div class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center page-loader">
    <div class="text-2xl font-bold text-gray-800 dark:text-white loader-text">Loading...</div>
  </div>

  <div class="min-h-screen max-w-4xl mx-auto px-4 py-8 relative z-10 page-content">
    <div class="flex items-center justify-between mb-10">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Public Repos</h1>
      <a href="/" class="text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Home
      </a>
    </div>
    
    <SearchBar placeholder="Search repos..." />
    
    <div id="repos-container"></div>
    
    <div id="pagination-container" class="mt-12 flex justify-center"></div>
  </div>
  
  <Footer />
</Layout>

<script src="../../scripts/shared-layout"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const reposContainer = document.getElementById('repos-container');
    const paginationContainer = document.getElementById('pagination-container');
    const REPOS_PER_PAGE = 5;
    
    let currentPage = 1;
    let sortedRepos: string | any[] = [];
    
    fetch('/api/repos')
      .then(response => response.json())
      .then((data) => {
        sortedRepos = data;
        loadPage(currentPage);
      })
      .catch(error => {
        console.error('Error fetching repos:', error);
      });
    
    function loadPage(page: number) {
      currentPage = page;
      const startIndex = (page - 1) * REPOS_PER_PAGE;
      const endIndex = startIndex + REPOS_PER_PAGE;
      const paginatedRepos = sortedRepos.slice(startIndex, endIndex) as any[];
      
      renderRepos(paginatedRepos);
      renderPagination(page, Math.ceil(sortedRepos.length / REPOS_PER_PAGE) || 1);
      
      setTimeout(() => {
        applyCardAnimations();
      }, 500);
    }
    
    function applyCardAnimations() {
      const cards = document.querySelectorAll('.staggered-card');
      cards.forEach((card, index) => {
        setTimeout(() => {
          card.classList.add('card-ready');
        }, index * 150);
      });
    }
    
    function renderRepos(repos: any[]) {
      if (!reposContainer) return;
      
      if (repos.length === 0) {
        reposContainer.innerHTML = `
          <div class="text-center py-12">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">No repos yet</h2>
            <p class="text-gray-600 dark:text-gray-400">Check back later for new repositories.</p>
          </div>
        `;
        return;
      }
      
      reposContainer.innerHTML = `
        <div class="grid grid-cols-1 gap-6 cards-container">
          ${repos.map((repo, index) => `
            <article class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 staggered-card transform hover:-translate-y-1" data-index="${index}">
              <div class="p-6">
                <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-3">
                  <a href="/repos/${repo.slug}" class="hover:underline">${repo.title}</a>
                </h2>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                  ${repo.description}
                </p>
                <div class="flex flex-wrap gap-2">
                  ${repo.tags?.map((tag: any) => `
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded dark:bg-blue-900 dark:text-blue-300">${tag}</span>
                  `).join('') || ''}
                </div>
              </div>
            </article>
          `).join('')}
        </div>
      `;
    }
    
    function renderPagination(currentPage: number, totalPages: number) {
      if (!paginationContainer) return;
      
      let paginationHTML = `
        <nav class="flex items-center space-x-2">
      `;
      
      if (currentPage > 1) {
        paginationHTML += `
          <button data-page="${currentPage - 1}" class="px-3 py-1 text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 rounded">Previous</button>
        `;
      } else {
        paginationHTML += `
          <span class="px-3 py-1 text-gray-500 dark:text-gray-400">Previous</span>
        `;
      }
      
      for (let page = 1; page <= totalPages; page++) {
        paginationHTML += `
          <button 
            data-page="${page}"
            class="px-3 py-1 rounded ${page === currentPage ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700'}"
          >
            ${page}
          </button>
        `;
      }
      
      if (currentPage < totalPages) {
        paginationHTML += `
          <button data-page="${currentPage + 1}" class="px-3 py-1 text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 rounded">Next</button>
        `;
      } else {
        paginationHTML += `
          <span class="px-3 py-1 text-gray-500 dark:text-gray-400">Next</span>
        `;
      }
      
      paginationHTML += `
        </nav>
      `;
      
      paginationContainer.innerHTML = paginationHTML;
      
      document.querySelectorAll('#pagination-container button').forEach(button => {
        button.addEventListener('click', (e: any) => {
          const target = /** @type {HTMLElement} */ (e.target);
          const page = parseInt(target.dataset.page);
          if (page) {
            loadPage(page);
            const container = document.querySelector('#repos-container');
            if (container) {
              container.scrollIntoView({ behavior: 'smooth' });
            }
          }
        });
      });
    }
  });
</script>